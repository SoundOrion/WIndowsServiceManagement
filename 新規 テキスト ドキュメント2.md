いいね、**NSSMでnginxをWindowsサービス登録**するメニューをあなたのツールに追加しましょう。
以下の差分をそのまま入れれば動きます（`cmd.exe /c` でNSSMを叩きます）。

---

## 1) メニュー項目を追加

```csharp
Console.WriteLine("[1] 登録(create)  [2] 起動(start)  [3] 停止(stop)  [4] 削除(delete)");
Console.WriteLine("[5] 状態(query)   [6] 説明設定(description)  [7] 自動/手動 切替");
Console.WriteLine("[8] SeServiceLogon 付与  [9] services.msc を開く");
Console.WriteLine("[10] NSSMでnginxを登録/更新  [11] NSSMでアンインストール");
```

switch に追記：

```csharp
case "10": InstallOrUpdateNginxWithNssm(cfg); break;
case "11": UninstallNssmService(cfg); break;
```

---

## 2) App.config に設定キーを追加

```xml
<appSettings>
  <!-- 既存 -->
  <add key="ServiceName" value="nginx" />
  <add key="DisplayName" value="nginx (via NSSM)" />
  <add key="StartupType" value="auto" />
  <add key="Description" value="nginx reverse proxy" />
  <!-- 実行アカウントは必要なら： .\User / DOMAIN\User -->
  <add key="ServiceUser" value="" />
  <add key="ServicePassword" value="" />

  <!-- ★ NSSM / nginx 用 -->
  <add key="NssmPath" value="C:\tools\nssm\nssm.exe" />
  <add key="NginxExe"  value="C:\nginx\nginx.exe" />
  <add key="NginxHome" value="C:\nginx" />
  <add key="NginxConf" value="conf\nginx.conf" />
  <!-- 追加パラメータがあれば。空でOK（例："-g \"daemon off;\"" は不要） -->
  <add key="NginxExtraArgs" value="" />
  <add key="NginxLogsDir" value="C:\nginx\logs" />

  <!-- 任意：回復・遅延・依存 -->
  <add key="Dependencies" value="Tcpip/Afd" />
  <add key="DelayedAutoStart" value="true" />
  <add key="EnableRecovery" value="true" />
</appSettings>
```

`ServiceConfig` にプロパティを追加：

```csharp
public string NssmPath { get; set; }
public string NginxExe  { get; set; }
public string NginxHome { get; set; }
public string NginxConf { get; set; }
public string NginxExtraArgs { get; set; }
public string NginxLogsDir { get; set; }
public bool DelayedAutoStart { get; set; }
public bool EnableRecovery { get; set; }
```

`Load()` に読み込みを追加：

```csharp
NssmPath = Get("NssmPath") ?? @"C:\tools\nssm\nssm.exe",
NginxExe  = Get("NginxExe")  ?? @"C:\nginx\nginx.exe",
NginxHome = Get("NginxHome") ?? @"C:\nginx",
NginxConf = Get("NginxConf") ?? @"conf\nginx.conf",
NginxExtraArgs = Get("NginxExtraArgs") ?? "",
NginxLogsDir = Get("NginxLogsDir") ?? @"C:\nginx\logs",
DelayedAutoStart = string.Equals(Get("DelayedAutoStart"), "true", StringComparison.OrdinalIgnoreCase),
EnableRecovery   = string.Equals(Get("EnableRecovery"),   "true", StringComparison.OrdinalIgnoreCase),
```

---

## 3) NSSM で nginx を登録/更新する処理を追加

```csharp
static void InstallOrUpdateNginxWithNssm(ServiceConfig cfg)
{
    // 事前チェック
    if (!System.IO.File.Exists(cfg.NssmPath))
        throw new Exception($"NSSM が見つかりません: {cfg.NssmPath}");
    if (!System.IO.File.Exists(cfg.NginxExe))
        throw new Exception($"nginx.exe が見つかりません: {cfg.NginxExe}");

    var svc = cfg.ServiceName;
    var nssm = Q(cfg.NssmPath);
    var app = Q(cfg.NginxExe);
    var appDir = Q(cfg.NginxHome);
    var logs = cfg.NginxLogsDir;
    var stdout = Q(System.IO.Path.Combine(logs, "nginx-service.out.log"));
    var stderr = Q(System.IO.Path.Combine(logs, "nginx-service.err.log"));

    // パラメータ: -p <home> -c <conf> [extra]
    var parameters = $"-p {cfg.NginxHome} -c {cfg.NginxConf}";
    if (!string.IsNullOrWhiteSpace(cfg.NginxExtraArgs))
        parameters += " " + cfg.NginxExtraArgs;
    var appParams = Q(parameters);

    // インストール or 再設定
    // nssm install <name> <exe> （AppParametersは set で渡す）
    if (!Confirm($"NSSMで {svc} を登録/更新します。\n  {cfg.NssmPath} install {svc} {cfg.NginxExe}\n  AppParameters={parameters}"))
        return;

    // install（既存なら上書き扱いでOK）
    RunCmd($"{nssm} install {Q(svc)} {app}");
    // ディレクトリ・引数・ログ
    RunCmd($"{nssm} set {Q(svc)} AppDirectory {appDir}");
    RunCmd($"{nssm} set {Q(svc)} AppParameters {appParams}");
    RunCmd($"{nssm} set {Q(svc)} AppStdout {stdout}");
    RunCmd($"{nssm} set {Q(svc)} AppStderr {stderr}");
    RunCmd($"{nssm} set {Q(svc)} AppStdoutCreationDisposition 2"); // 2=append
    RunCmd($"{nssm} set {Q(svc)} AppStderrCreationDisposition 2");
    RunCmd($"{nssm} set {Q(svc)} AppRotateFiles 1");
    RunCmd($"{nssm} set {Q(svc)} AppRotateBytes 10485760");
    RunCmd($"{nssm} set {Q(svc)} AppRotateOnline 1");

    // 起動種別（auto/demand/disabled）→ NSSM は Start に SERVICE_* を使うが、
    // 分かりやすく sc で確実に設定しておく
    RunCmd($"sc config {Q(svc)} start= {cfg.StartupType}");

    // 遅延自動
    if (cfg.DelayedAutoStart && cfg.StartupType == "auto")
        RunCmd($"sc config {Q(svc)} start= delayed-auto");

    // 依存関係
    if (!string.IsNullOrWhiteSpace(cfg.Dependencies))
        RunCmd($"sc config {Q(svc)} depend= {Q(cfg.Dependencies)}");

    // 実行アカウント
    if (!string.IsNullOrWhiteSpace(cfg.ServiceUser))
        RunCmd($"sc config {Q(svc)} obj= {Q(cfg.ServiceUser)} password= {Q(cfg.ServicePassword ?? "")}");

    // 説明
    if (!string.IsNullOrWhiteSpace(cfg.Description))
        RunCmd($"sc description {Q(svc)} {Q(cfg.Description)}");

    // 回復設定
    if (cfg.EnableRecovery)
    {
        RunCmd($"sc failure {Q(svc)} reset= 86400 actions= restart/60000/restart/60000/restart/60000");
        RunCmd($"sc failureflag {Q(svc)} 1");
    }

    Console.ForegroundColor = ConsoleColor.Green;
    Console.WriteLine("NSSMでの登録/更新が完了しました。必要なら [2] 起動 を実行してください。");
    Console.ResetColor();
}
```

---

## 4) NSSM でアンインストールする処理

```csharp
static void UninstallNssmService(ServiceConfig cfg)
{
    if (!System.IO.File.Exists(cfg.NssmPath))
        throw new Exception($"NSSM が見つかりません: {cfg.NssmPath}");

    var nssm = Q(cfg.NssmPath);
    var svc = cfg.ServiceName;

    if (!Confirm($"NSSMでサービス {svc} をアンインストールします（停止・削除）。よろしいですか？"))
        return;

    // 停止は nssm stop / または net stop
    RunCmd($"{nssm} stop {Q(svc)}");
    // remove は /confirm オプション（古い版は引数なしで確認プロンプト）
    RunCmd($"{nssm} remove {Q(svc)} confirm");
}
```

---

## 5) 使い方のポイント

* **NSSM本体（nssm.exe）** を `NssmPath` に置いてください。
  例：`C:\tools\nssm\nssm.exe`
* `NginxExe` / `NginxHome` / `NginxConf` をあなたの配置に合わせる
  例：`NginxExe=C:\nginx\nginx.exe`、`NginxHome=C:\nginx`、`NginxConf=conf\nginx.conf`
* ログは `NginxLogsDir` にローテーション付きで出します（10MB単位）
* **実行アカウント**を指定したい場合は `ServiceUser` / `ServicePassword` を設定
  （指定しなければ LocalSystem）
* 起動後の確認はメニュー `[5] 状態` や `[9] services.msc を開く` で

---

## 6) なぜ NSSM を使うの？

* `nginx.exe` は「Ctrl+C/TERM シグナル処理」「log リダイレクト」「ワーキングディレクトリ」などで微調整が欲しい時がある
* NSSM は**標準出力/標準エラーのログ化**・**ローテーション**・**GUIなしの安定常駐**を簡単にしてくれる
* 将来 nginx 以外（Node/Kestrel/独自ツール）でも同じ手順でサービス化できる

---

これで **「cmd.exe /c で NSSM を使って nginx をサービス登録」** が、
あなたの既存ツールからワンキーでできます。

必要なら、**証明書のACL（SYSTEM読み取り）**や**ファイアウォール開放**まで一緒にやるメニューも足せます。

了解です！
提案どおり **「証明書キーのACL付与」** と **「ファイアウォール開放/削除」** をメニューに追加できる差分をまとめました。
そのまま貼り足せば動きます。

---

## 1) メニューを追加

```csharp
Console.WriteLine("[10] NSSMでnginxを登録/更新  [11] NSSMでアンインストール");
Console.WriteLine("[12] ファイアウォール開放(追加)  [13] ファイアウォール削除");
Console.WriteLine("[14] 証明書キーにACL付与(SYSTEM/実行アカウント)  [15] ログディレクトリ作成");
```

switch に追記：

```csharp
case "10": InstallOrUpdateNginxWithNssm(cfg); break;
case "11": UninstallNssmService(cfg); break;
case "12": OpenFirewall(cfg); break;
case "13": RemoveFirewall(cfg); break;
case "14": GrantCertAcl(cfg); break;
case "15": EnsureLogsDir(cfg); break;
```

---

## 2) App.config に設定キーを追加

```xml
<appSettings>
  <!-- 既存は省略 -->

  <!-- ★ ファイアウォール設定：カンマ区切りでポート指定 -->
  <add key="FirewallPorts" value="80,443" />

  <!-- ★ 証明書の秘密鍵ファイル（PEM/KEYなど）への絶対パス（空なら無視） -->
  <add key="CertKeyPath" value="C:\nginx\certs\privkey.key" />
</appSettings>
```

`ServiceConfig` にプロパティを追加：

```csharp
public string FirewallPorts { get; set; }   // "80,443"
public string CertKeyPath { get; set; }     // "C:\nginx\certs\privkey.key"
```

`Load()` に読み込みを追加：

```csharp
FirewallPorts = Get("FirewallPorts") ?? "80,443",
CertKeyPath   = Get("CertKeyPath")   ?? "",
```

---

## 3) 追加する処理本体

```csharp
using System.IO; // ファイル/ディレクトリ操作で必要

static void OpenFirewall(ServiceConfig cfg)
{
    var ports = (cfg.FirewallPorts ?? "").Split(new[] {',',';',' '}, StringSplitOptions.RemoveEmptyEntries);
    if (ports.Length == 0) { Console.WriteLine("開放するポートが設定されていません。"); return; }

    if (!Confirm($"次のポートを受信許可します: {string.Join(", ", ports)}\n実行しますか？"))
        return;

    foreach (var p in ports)
    {
        var port = p.Trim();
        var name = $"{cfg.ServiceName} {port}";
        RunCmd($"netsh advfirewall firewall add rule name={Q(name)} dir=in action=allow protocol=TCP localport={port}");
    }
    Console.ForegroundColor = ConsoleColor.Green;
    Console.WriteLine("ファイアウォール追加が完了しました。");
    Console.ResetColor();
}

static void RemoveFirewall(ServiceConfig cfg)
{
    var ports = (cfg.FirewallPorts ?? "").Split(new[] {',',';',' '}, StringSplitOptions.RemoveEmptyEntries);
    if (ports.Length == 0) { Console.WriteLine("削除するポートが設定されていません。"); return; }

    if (!Confirm($"次のポートの受信許可ルール（{cfg.ServiceName} 名前）を削除します: {string.Join(", ", ports)}\n実行しますか？"))
        return;

    foreach (var p in ports)
    {
        var port = p.Trim();
        var name = $"{cfg.ServiceName} {port}";
        // ルール名で削除（存在しない場合は黙ってスキップ）
        RunCmd($"netsh advfirewall firewall delete rule name={Q(name)} protocol=TCP localport={port}");
    }
    Console.ForegroundColor = ConsoleColor.Green;
    Console.WriteLine("ファイアウォール削除が完了しました。");
    Console.ResetColor();
}

static void GrantCertAcl(ServiceConfig cfg)
{
    if (string.IsNullOrWhiteSpace(cfg.CertKeyPath) || !File.Exists(cfg.CertKeyPath))
    {
        Console.WriteLine("CertKeyPath が未設定、またはファイルが見つかりません。");
        return;
    }

    // 付与対象を組み立て
    var targets = new System.Collections.Generic.List<string>();
    targets.Add(@"NT AUTHORITY\SYSTEM"); // LocalSystemでの実行に必須

    // 実行アカウントにも付与（NetworkServiceや指定ユーザーなど）
    var acct = (cfg.ServiceUser ?? "").Trim();
    if (!string.IsNullOrEmpty(acct))
        targets.Add(acct);

    Console.WriteLine("次のアカウントに証明書秘密鍵の読み取り（R）を付与します：");
    foreach (var t in targets) Console.WriteLine("  - " + t);
    Console.WriteLine("対象ファイル: " + cfg.CertKeyPath);

    if (!Confirm("実行しますか？")) return;

    foreach (var t in targets)
    {
        // icacls "file" /grant "ACCOUNT":R
        RunCmd($"icacls {Q(cfg.CertKeyPath)} /grant {Q(t + ":R")}");
    }

    Console.ForegroundColor = ConsoleColor.Green;
    Console.WriteLine("証明書キーのACL付与が完了しました。");
    Console.ResetColor();
}

static void EnsureLogsDir(ServiceConfig cfg)
{
    if (string.IsNullOrWhiteSpace(cfg.NginxLogsDir))
    {
        Console.WriteLine("NginxLogsDir が未設定です。");
        return;
    }
    try
    {
        Directory.CreateDirectory(cfg.NginxLogsDir);
        Console.ForegroundColor = ConsoleColor.Green;
        Console.WriteLine($"ログディレクトリを確認/作成しました: {cfg.NginxLogsDir}");
        Console.ResetColor();
    }
    catch (Exception ex)
    {
        Console.ForegroundColor = ConsoleColor.Red;
        Console.WriteLine("ログディレクトリ作成に失敗: " + ex.Message);
        Console.ResetColor();
    }
}
```

> 補足
>
> * **NetworkService** で動かす場合は `ServiceUser` に `NT AUTHORITY\NetworkService` を入れておくと、`GrantCertAcl` が自動で付与します。
> * ファイルパスにスペースがある場合でも `Q()` で安全に引用します。
> * 先に `[15] ログディレクトリ作成` を実行してから NSSM 登録（`[10]`）すると、ログ出力設定でこけにくいです。

---

## 4) 運用の流れ（例）

1. `[15] ログディレクトリ作成`
2. `[14] 証明書キーにACL付与`（HTTPSを使う場合）
3. `[12] ファイアウォール開放(追加)`（80/443）
4. `[10] NSSMでnginxを登録/更新`
5. `[2] 起動` → `[5] 状態` で確認
6. トラブル時は `[13]` でFWルールを掃除、`[11]` でアンインストール

---

必要なら、**nginx.conf（HTTP/HTTPS/リバースプロキシ最小）**も一緒に出します。
このまま進められますが、他にも自動でやりたい項目（例：`depend= Tcpip/Afd` の既定化、回復設定の有効化/無効化トグル）あれば言ってください！
